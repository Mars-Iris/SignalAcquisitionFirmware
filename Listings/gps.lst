C51 COMPILER V9.56.0.0   GPS                                                               11/15/2022 13:44:47 PAGE 1   


C51 COMPILER V9.56.0.0, COMPILATION OF MODULE GPS
OBJECT MODULE PLACED IN .\Objects\gps.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE App\gps.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\g
                    -ps.lst) TABS(2) OBJECT(.\Objects\gps.obj)

line level    source

   1          #include <stdio.h>
   2          #include <string.h>
   3          #include  "./User/config.h"
   4          #include  "./User/includes.h"
   5          
   6          
   7          
   8          
   9          #ifdef  STC15W4K48S4
  10          
  11          #if GPS_USART
  12          
  13          xdata u8 GpsRxBuffer[128]=""; //Ω” ’ª∫≥Â
  14          
  15          u8 code CMD_GpsConfFail[] = {0x53,0x5A,0x43,0x47};//Gps≈‰÷√ ß∞‹÷∏¡Ó
  16          u8 code CMD_GpsConfSucc[] = {0x44,0x51,0x43,0x47,0x00};//Gps≈‰÷√≥…π¶÷∏¡Ó
  17          
  18          
  19          char code  CMD_GpsAckSucc[] = "OK";//Gps≈‰÷√≥…π¶÷∏¡Ó
  20          
  21          char code  CMD_BY_BaseAuto[] =  "fix auto\r\n";//◊‘∂ØªÒ»°ª˘◊º’æ◊¯±Í
  22          char code  CMD_BY_GetBasePos[] =  "log refstationa\r\n";//ªÒ»°ª˘◊º’æ◊¯±Í
  23          
  24          char code  CMD_HX_BaseAuto[] =  "fix auto\r\n";//◊‘∂ØªÒ»°ª˘◊º’æ◊¯±Í
  25          char code  CMD_HX_GetBasePos[] =  "log bestposa\r\n";//ªÒ»°ª˘◊º’æ◊¯±Í
  26          
  27          
  28          char code  CMD_ConfigEnd[] = "Configuration complete\r\n";//≈‰÷√Ω· ¯÷∏¡Ó£¨”√”⁄≥Ã–Úµƒ—≠ª∑ «∑ÒΩ· ¯£¨”ÎGPS≈‰÷
             -√Œﬁπÿ£¨±ÿ–Î”–£°£°
  29          char code  CMD_BY_BaseStation[][CMD_GPS_LENTH] =         //±±‘∆GPSª˘◊º’æ÷∏¡Ó
  30          {
  31            "interfacemode com3 bynav bynav\r\n",//£®≈‰÷√∂Àø⁄µƒ ‰»Î¿‡–ÕŒ™bynav£©
  32            "interfacemode com2 rtcm rtcm\r\n",//£®≈‰÷√∂Àø⁄ ‰≥ˆ¿‡–ÕŒ™rtcm£©
  33            "rtktype base\r\n",// //…Ë÷√Œ™ª˘◊º’æ
  34            "fix auto\r\n",////◊‘∂ØªÒ»°ª˘◊º’æ◊¯±Í
  35            "serialconfig com1 38400\r\n",//
  36            "serialconfig com2 38400\r\n",//
  37            "serialconfig com3 38400\r\n",//
  38            "log com2 rtcm1074 ontime 1\r\n",//
  39            "log com2 rtcm1084 ontime 1\r\n",//
  40            "log com2 rtcm1114 ontime 1\r\n",//
  41            "log com2 rtcm1124 ontime 1\r\n",//
  42            "log com2 rtcm1006 ontime 5\r\n",//
  43            "log com2 rtcm1033 ontime 10\r\n",//
  44            "unlogall com3\r\n",//
  45            "log com3 gpgga ontime 1\r\n",//
  46            "saveconfig\r\n",             //
  47            "reboot\r\n",                 // //÷ÿ∆Ù   
  48            "Configuration complete\r\n"  //≈‰÷√Ω· ¯÷∏¡Ó£¨”√”⁄≥Ã–Úµƒ—≠ª∑ «∑ÒΩ· ¯£¨”ÎGPS≈‰÷√Œﬁπÿ£¨±ÿ–Î”–£°£° 
  49          };
  50          
  51          char code  CMD_BY_MobileStation[][CMD_GPS_LENTH] =         //±±‘∆GPS“∆∂Ø’æ≈‰÷√÷∏¡Ó
  52          {
  53            "interfacemode com3 bynav bynav\r\n",//
C51 COMPILER V9.56.0.0   GPS                                                               11/15/2022 13:44:47 PAGE 2   

  54            "unlogall\r\n",
  55            "interfacemode com2 rtcm rtcm\r\n",
  56            "rtktypertk rover\r\n",
  57            "interfacemode com3 bynav bynav\r\n",
  58            "serialconfig com2 38400\r\n",
  59            "serialconfig com3 38400\r\n",
  60            "serialconfig com1 38400\r\n",
  61            "log com3 ptnlpjk ontime 0.1\r\n",
  62            "log com3 gpvtg ontime 0.1\r\n",
  63            "log com3 ptnlavr ontime 0.1\r\n",
  64            "saveconfig\r\n",   
  65            "Configuration complete\r\n", //≈‰÷√Ω· ¯÷∏¡Ó£¨”√”⁄≥Ã–Úµƒ—≠ª∑ «∑ÒΩ· ¯£¨”ÎGPS≈‰÷√Œﬁπÿ£¨±ÿ–Î”–£°£°
  66          };
  67          
  68          char code  CMD_HX_BaseStation[][CMD_GPS_LENTH] =         //∫œ–æGPSª˘◊º’æ÷∏¡Ó
  69          {
  70            "lmode base time 60 1.5 2.5\r\n",       //Ω´GPS…Ë÷√Œ™ª˘◊º’æ
  71            "fix auto\r\n",                     //◊‘∂ØªÒ»°ª˘◊º’æ◊¯±Í
  72            "unlog com3\r\n",               
  73            "log com2 rtcm1033 ontime 10\r\n",                  
  74            "log com2 rtcm1006 ontime 10\r\n",//
  75            "log com2 rtcm1074 ontime 1\r\n",//
  76            "log com2 rtcm1084 ontime 1\r\n",//
  77            "log com2 rtcm1124 ontime 1\r\n",//
  78            "log com2 rtcm1094 ontime 1\r\n",//
  79            "config com2 38400\r\n",//
  80            "config com3 38400\r\n",//
  81            "saveconfig\r\n",//   
  82            "Configuration complete\r\n"  //≈‰÷√Ω· ¯÷∏¡Ó£¨”√”⁄≥Ã–Úµƒ—≠ª∑ «∑ÒΩ· ¯£¨”ÎGPS≈‰÷√Œﬁπÿ£¨±ÿ–Î”–£°£°
  83          };
  84          
  85          
  86          char code  CMD_HX10Hz_MobileStation[][CMD_GPS_LENTH] =         //∫œ–æGPS“∆∂Ø’æ÷∏¡Ó
  87          {
  88            "log headinga ontime 1\r\n",        //Ω´GPS…Ë÷√Œ™ª˘◊º’æ
  89            "com com2 38400\r\n",                     //◊‘∂ØªÒ»°ª˘◊º’æ◊¯±Í
  90            "com com3 38400\r\n",               
  91            "Unlogall com2\r\n",                  
  92            "Unlogall com3\r\n",//
  93            "log com3 gpntr ontime 0.1\r\n",//
  94            "log com3 gptra onchanged\r\n",//
  95            "log com3 gpvtg ontime 0.1\r\n",//
  96            "log com3 gprmc ontime 0.1\r\n",//
  97            "Headingmode variablelength \r\n",//
  98            "mode rover\r\n",//
  99            "saveconfig\r\n",//   
 100            "Configuration complete\r\n"  //≈‰÷√Ω· ¯÷∏¡Ó£¨”√”⁄≥Ã–Úµƒ—≠ª∑ «∑ÒΩ· ¯£¨”ÎGPS≈‰÷√Œﬁπÿ£¨±ÿ–Î”–£°£° 
 101          };
 102          
 103          char code  CMD_HX5Hz_MobileStation[][CMD_GPS_LENTH] =         //∫œ–æGPS“∆∂Ø’æ÷∏¡Ó
 104          {
 105            "log headinga ontime 1\r\n",        //Ω´GPS…Ë÷√Œ™ª˘◊º’æ
 106            "com com2 38400\r\n",                     //◊‘∂ØªÒ»°ª˘◊º’æ◊¯±Í
 107            "com com3 38400\r\n",               
 108            "Unlogall com2\r\n",                  
 109            "Unlogall com3\r\n",//
 110            "log com3 gpntr ontime 0.2\r\n",//
 111            "log com3 gptra onchanged\r\n",//
 112            "log com3 gpvtg ontime 0.2\r\n",//
 113            "log com3 gprmc ontime 0.2\r\n",//
 114            "Headingmode variablelength \r\n",//
 115            "mode rover\r\n",//
C51 COMPILER V9.56.0.0   GPS                                                               11/15/2022 13:44:47 PAGE 3   

 116            "saveconfig\r\n",//   
 117            "Configuration complete\r\n"  //≈‰÷√Ω· ¯÷∏¡Ó£¨”√”⁄≥Ã–Úµƒ—≠ª∑ «∑ÒΩ· ¯£¨”ÎGPS≈‰÷√Œﬁπÿ£¨±ÿ–Î”–£°£° 
 118          };
 119          //========================================================================
 120          // ∫Ø ˝: u8 GPS_Configuration(u8 USARTx,char *dat)
 121          // √Ë ˆ: ≈‰÷√gps£¨∏¯gps∑¢ÀÕ÷∏¡Ó£¨Õ¨ ±ø…∏˘æ›÷∏¡Ó∑µªÿ≤Ó∑÷’æ◊¯±Í
 122           //      ¡¨–¯≥¢ ‘3¥Œ£¨≤ª≥…π¶º¥≈‰÷√ ß∞‹
 123          // ≤Œ ˝£∫u8 USARTx,≈‰÷√¥Æø⁄£¨char *cmd ÷∏œÚ÷∏¡Óµƒµÿ÷∑
 124          // ∑µªÿ: Œﬁ
 125          // ∞Ê±æ: V1.0, 2022-10-17
 126          //========================================================================
 127          static u8 Configuration(u8 USARTx,char *cmd)  //≈‰÷√GPS∞Âø®
 128          {
 129   1        xdata u8 i=0;
 130   1        xdata u8 times=3;
 131   1        
 132   1        //printf("GPS_Configuration\r\n");
 133   1        
 134   1        while (times--)
 135   1        {
 136   2          
 137   2          if (strcmp(cmd,CMD_HX_BaseAuto) == 0)  //fix auto\r\n”Î±±‘∆Õ®”√
 138   2          {
 139   3            delay_ms(3000); //—” ±3√Î∫Û£¨ªÒ»°≤Ó∑÷’æµƒ∂®Œª◊¯±Í
 140   3          }
 141   2          
 142   2          BSP_ClearUsartRxBuffer(USARTx);//«Â¥Æø⁄ª∫¥Ê
 143   2          
 144   2          USART_Sendbuffer(USARTx,cmd,strlen(cmd));//∑¢ÀÕ≈‰÷√÷∏¡Ó
 145   2          
 146   2          delay_ms(300);//—” ±350∂¡»°∞Âø®ªÿ∏¥
 147   2          
 148   2          memset(GpsRxBuffer, 0, sizeof(GpsRxBuffer));//«Âª∫¥Ê ˝æ›
 149   2          
 150   2          BSP_GetUsartRxBuffer(USARTx,GpsRxBuffer,sizeof(GpsRxBuffer));//∂¡»°¥Æø⁄ ˝æ›
 151   2                
 152   2          if(strstr((char *)GpsRxBuffer,CMD_GpsAckSucc) != NULL)  //Gps≈‰÷√≥…π¶÷∏¡Ó”¶¥≥…π¶OK
 153   2          {
 154   3            if (strstr(cmd,"com3 38400") != NULL) //∏ƒ±‰¥Æø⁄≤®Ãÿ¬ ÷∏¡Óserialconfig com3 38400\r\n
 155   3            {
 156   4              BSP_Usart_Init(USARTx,38400); //≤®Ãÿ¬ ∫ÕGPS¥Æø⁄≤®Ãÿ¬ Õ¨≤Ω
 157   4              S1_USE_P16P17();//STC«–ªª¥Æø⁄1µΩGPS¥Æø⁄
 158   4            }
 159   3            return(1);// ’µΩGPS’˝»∑µƒªÿ∏¥
 160   3          }
 161   2        }
 162   1        return(0);//Œ¥ ’µΩGPS’˝»∑µƒªÿ∏¥
 163   1      }
 164          //========================================================================
 165          // ∫Ø ˝: void GPS_EnterConfig(u8 USARTx, char **pcmd) //≈‰÷√GPS
 166          // √Ë ˆ: ∞¥’’÷∏¡ÓºØ∫œpcmdµƒ÷∏¡Ó≈‰÷√GPS“∆∂Ø’æ£¨÷∏¡ÓºØ∫œ÷–◊Ó∫Û“ªÃı÷∏¡Ó±ÿ–Î «CMD_ConfigEnd
 167          // ≤Œ ˝£∫u8 USARTx,≈‰÷√¥Æø⁄,char (*pcmd)[CMD_GPS_LENTH]÷∏œÚ÷∏¡ÓºØ∫œµƒ÷∏’Î
 168          // ∑µªÿ: Œﬁ
 169          // ∞Ê±æ: V1.0, 2022-10-17
 170          //========================================================================
 171          static void EnterConfig(u8 USARTx, char (*pcmd)[CMD_GPS_LENTH]) 
 172          {
 173   1        xdata u8 Index = 0;//÷∏¡Ó–Ú∫≈
 174   1        xdata u8 temp = 0;//
 175   1          
 176   1        S1_Int_on();//ø™¥Æø⁄1÷–∂œ
 177   1        
C51 COMPILER V9.56.0.0   GPS                                                               11/15/2022 13:44:47 PAGE 4   

 178   1        BSP_Usart_Init(USARTx,115200);//≤‚ ‘≤®Ãÿ¬ 
 179   1        S1_USE_P16P17();//STC«–ªª¥Æø⁄1µΩGPS¥Æø⁄
 180   1        
 181   1        if(Configuration(USARTx,pcmd[Index]) == 0)//≈‰÷√ ß∞‹
 182   1        {
 183   2           BSP_Usart_Init(USARTx,38400);//≤‚ ‘≤®Ãÿ¬ 
 184   2           S1_USE_P16P17();//STC«–ªª¥Æø⁄1µΩGPS¥Æø⁄
 185   2        }
 186   1        if(Configuration(USARTx,pcmd[Index]) == 0)//≈‰÷√ ß∞‹
 187   1        {
 188   2           BSP_Usart_Init(USARTx,19200);//≤‚ ‘≤®Ãÿ¬ 
 189   2            S1_USE_P16P17();//STC«–ªª¥Æø⁄1µΩGPS¥Æø⁄
 190   2        }
 191   1        if(Configuration(USARTx,pcmd[Index]) == 1)//≤®Ãÿ¬   ≈‰≥…π¶ 
 192   1        {
 193   2          while(strstr(pcmd[Index],CMD_ConfigEnd) == NULL)//≤È—ØµΩ≈‰÷√ÕÍ≥…÷∏¡Ó£¨Ã¯≥ˆ—≠ª∑£¨≈‰÷√Ω· ¯
 194   2          {
 195   3            
 196   3            //printf("Index = %b02d\r\n",Index);
 197   3            
 198   3            temp = Configuration(USARTx,pcmd[Index]);//∑¢ÀÕ≈‰÷√÷∏¡Ó
 199   3              
 200   3            if (temp == 0)//≈‰÷√ ß∞‹
 201   3            {
 202   4              USART_Sendbuffer(USARTx,CMD_GpsConfFail,sizeof(CMD_GpsConfFail));//∑¢ÀÕ≈‰÷√ ß∞‹÷∏¡Ó
 203   4              
 204   4              USART_SendData(USARTx,Index);//∑¢ÀÕ¥Ì÷∏¡ÓÀ˜“˝
 205   4              
 206   4              //printf("GpsConfFail :Index = %b02d\r\n",Index);
 207   4              
 208   4              return;//≈‰÷√ ß∞‹
 209   4            }
 210   3            
 211   3            Index ++;//“∆µΩœ¬“ª∏ˆ÷∏¡Ó
 212   3                  
 213   3          }
 214   2        }
 215   1        USART_Sendbuffer(USARTx,CMD_GpsConfSucc,sizeof(CMD_GpsConfSucc));//”¶¥≈‰÷√≥…π¶
 216   1        
 217   1        //printf("GpsConfSucc\r\n",Index);      
 218   1      } 
 219          //========================================================================
 220          // ∫Ø ˝: void GetBaseStationPos(void) 
 221          // √Ë ˆ: µ√µΩGPSª˘◊º’æ◊¯±Í£¨…œ¥´∏¯…œŒªª˙
 222          // ≤Œ ˝£∫Œﬁ
 223          // ∑µªÿ: Œﬁ
 224          // ∞Ê±æ: V1.0, 2022-10-17
 225          //========================================================================
 226          void GetBaseStationPos(void)  
 227          {
 228   1        xdata u8 i = 0 ;  //
 229   1        xdata u8 type = 0 ;//ªÒ»°≈‰÷√Œƒº˛£¨µ√µΩgps¿‡–Õ
 230   1        BSP_ClearUsartRxBuffer(GPS_USART);//«Â¥Æø⁄ª∫¥Ê
 231   1        switch(type)
 232   1        {
 233   2          case BY_BASESTATION:
 234   2                    USART_Sendbuffer(GPS_USART,CMD_BY_GetBasePos,strlen(CMD_BY_GetBasePos));//∑¢ÀÕªÒ»°±±‘∆gpsª˘◊º’æ◊¯±Í
             -µƒ÷∏¡Ó  
 235   2          case HX_BASESTATION:
 236   2                    USART_Sendbuffer(GPS_USART,CMD_BY_GetBasePos,strlen(CMD_BY_GetBasePos));//∑¢ÀÕªÒ»°∫œ–ægpsª˘◊º’æ◊¯±Í
             -µƒ÷∏¡Ó      
 237   2          default:
C51 COMPILER V9.56.0.0   GPS                                                               11/15/2022 13:44:47 PAGE 5   

 238   2                  break;
 239   2                          
 240   2        } 
 241   1        delay_ms(300);
 242   1        
 243   1        memset(GpsRxBuffer, 0, sizeof(GpsRxBuffer));//«Âª∫¥Ê ˝æ›
 244   1          
 245   1        BSP_GetUsartRxBuffer(GPS_USART,GpsRxBuffer,sizeof(GpsRxBuffer));//∂¡»°¥Æø⁄ ˝æ›
 246   1          
 247   1        for(i=0;i<strlen((char *)GpsRxBuffer);i++)
 248   1        {   
 249   2          USART_SendData(UPLOAD_USART,GpsRxBuffer[i]);//ªÿ∏¥ª˘◊º’æ◊¯±Í
 250   2        }  
 251   1        BSP_ClearUsartRxBuffer(GPS_USART);//«Â¥Æø⁄ª∫¥Ê                      
 252   1      }
 253          
 254          
 255          
 256          //========================================================================
 257          // ∫Ø ˝: void GPS_EnterConfiguration(void)  
 258          // √Ë ˆ: Ω¯»ÎGPS≈‰÷√ƒ£ Ω
 259          // ≤Œ ˝£∫mode «÷∏∂®≤Ó∑÷’æªπ «“∆∂Ø’æ£¨”……œŒªª˙æˆ∂®
 260          // ∑µªÿ: Œﬁ
 261          // ∞Ê±æ: V1.0, 2022-10-17
 262          //========================================================================
 263          void GPS_EnterConfiguration(u8 mode)  
 264          {
 265   1        
 266   1        xdata u8 gpsmodel = 0 ;//ªÒ»°≈‰÷√Œƒº˛£¨µ√µΩgps–Õ∫≈
 267   1        gpsmodel = HX10HZ_MOBILESTATION;////ªÒ»°≈‰÷√Œƒº˛£¨µ√µΩgps–Õ∫≈
 268   1        
 269   1        if  (mode ==BASESTATION )
 270   1        {
 271   2            switch(gpsmodel)
 272   2            {
 273   3              case BY_BASESTATION:
 274   3                                  EnterConfig(GPS_USART,CMD_BY_BaseStation);//Ω¯»Î±±‘∆GPSª˘◊º’æ≈‰÷√
 275   3                                  break;
 276   3              case HX_BASESTATION:
 277   3                                  EnterConfig(GPS_USART,CMD_HX_BaseStation);//Ω¯»Î∫œ–æGPSª˘◊º’æ≈‰÷√
 278   3                                  break;    
 279   3              default:
 280   3                      break;
 281   3            }
 282   2                          
 283   2        } 
 284   1        if  (mode == MOBILESTATION)
 285   1        {
 286   2            switch(gpsmodel)
 287   2            {
 288   3              case BY_MOBILESTATION:
 289   3                                  EnterConfig(GPS_USART,CMD_BY_MobileStation);      //Ω¯»Î±±‘∆GPS“∆∂Ø’æ≈‰÷√
 290   3                                  break;
 291   3              case HX10HZ_MOBILESTATION:
 292   3                                  EnterConfig(GPS_USART,CMD_HX10Hz_MobileStation);  //Ω¯»Î∫œ–æ10HzGPS“∆∂Ø’æ≈‰÷√
 293   3                                  break;    
 294   3              case HX5HZ_MOBILESTATION:
 295   3                                  EnterConfig(GPS_USART,CMD_HX5Hz_MobileStation);   //Ω¯»Î∫œ–æ5HzGPS“∆∂Ø’æ≈‰÷√
 296   3                                  break;  
 297   3              default:
 298   3                      break;
 299   3            }   
C51 COMPILER V9.56.0.0   GPS                                                               11/15/2022 13:44:47 PAGE 6   

 300   2        }
 301   1          
 302   1                        
 303   1      }
 304          #endif
 305          
 306          #endif


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    662    ----
   CONSTANT SIZE    =   3603    ----
   XDATA SIZE       =    128       7
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       9
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
